<%- include ('../inc/header') %>

<h1 class="alert alert-info">Danh sách người dùng</h1>

<!-- Thêm form tìm kiếm -->
<form action="/users/list" method="GET">
    <input type="text" name="search" placeholder="Tìm kiếm người dùng">
    <button type="submit">Tìm kiếm</button>
</form>

<% if(typeof(users) !='undefined' && users.length> 0) { %>
    <table class="table table-bordered">
        <tr>
            <th>Họ và tên</th>
            <th>Email</th>
            <th>Địa chỉ</th>
            <th>Số điện thoại</th>
            <th>Chức danh</th>
            <th>Trạng thái</th>
            <th>Khóa</th>
        </tr>

        <% users.forEach((row)=> { %>
            <tr>
                <td>
                    <%= row.fullname %>
                </td>
                <td>
                    <%= row.email %>
                </td>
                <td>
                    <%= row.diaChi %>
                </td>
                <td>
                    <%= row.sdt %>
                </td>
                <td>
                    <% if(row.status=0) { %>
                        Admin
                        <% } else { %>
                            Người dùng
                            <% } %>
                </td>
                <td>
                    <% if(row.isLocked) { %>
                        Người dùng bị khóa
                        <% } else if(!row.isLocked) { %>
                            Hoạt động
                            <% } %>
                </td>
                <td>
                    <button class="lock-button" data-id="<%= row._id %>">
                        <% if(row.isLocked) { %>
                            Mở khóa
                            <% } else if(!row.isLocked) { %>
                                Khóa
                                <% } %>
                    </button>
                </td>
                <td>
                    <a href="/users/purchase-history/<%= row._id %>">Xem lịch sử mua</a>
                </td>

            </tr>
            <% }) %>
    </table>
    <% } else { %>
        Không có dữ liệu
        <% } %>

    <a href="/users" class="btn btn-primary">Thêm người dùng mới</a>

    <!-- Thêm nút phân trang -->
    <div class="pagination">
        <a href="?page=<%= page - 1 %>&search=<%= search %>">«</a>
        <a href="?page=<%= page %>&search=<%= search %>"><%= page %></a>
        <a href="?page=<%= page + 1 %>&search=<%= search %>">»</a>
    </div>

    <script>
        document.querySelectorAll('.lock-button').forEach(function (button) {
            button.addEventListener('click', function (event) {
                var userId = event.target.getAttribute('data-id');
                if (confirm('Bạn có muốn khóa người dùng này không?')) {
                    fetch('/users/lock/' + userId, {
                        method: 'POST',
                    }).then(function (response) {
                        if (response.ok) {
                            return response.text();
                        } else {
                            throw new Error('Lỗi khi khóa người dùng');
                        }
                    }).then(function () {
                        window.location.reload();
                    }).catch(function (error) {
                        console.error('Lỗi:', error);
                    });
                }
            });
        });
    </script>

<%- include ('../inc/footer') %>
